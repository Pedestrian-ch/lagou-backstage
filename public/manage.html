<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>拉勾网管理系统</title>
    <link rel="stylesheet" href="./stylesheets/bootstrap.min.css">
    <style>
        .modal-body .form-group{
            margin: 0;
        }
    </style>
</head>

<body>
    <!-- 导航条 -->
    <div class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
        <div class="container">
            <a href="#" class="navbar-brand">拉勾网管理系统</a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav"
                aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav mr-auto">
                    <li class="nav-item">
                        <a href="/" class="nav-link">首页</a>
                    </li>
                    <li class="nav-item">
                        <a href="/manage" class="nav-link active">职位管理</a>
                    </li>
                </ul>
                <ul class="navbar-nav">
                    <li id="loginup"></li>
                    <li id="loginout"></li>
                </ul>
            </div>
        </div>
    </div>

    <!-- 注册弹窗 -->
    <div class="modal fade" id="register" tabindex="-1" role="dialog" aria-labelledby="registerTitle"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title" id="registerTitle"><b>用户注册</b></h4>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close" style="outline:none">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <form action="/register" method="POST" id="registered" target="register_display">
                    <div class="modal-body">
                        <div class="form-group">
                            <label for="usernamer" class="col-form-label"><b>用户名</b></label>
                            <input type="text" class="form-control" id="usernamer" name="username" placeholder="输入用户名">
                        </div>
                        <div class="form-group">
                            <label for="passwordr" class="col-form-label"><b>密码</b></label>
                            <input type="password" class="form-control" id="passwordr" name="password"
                                placeholder="输入密码">
                        </div>
                        <div class="form-group">
                            <label for="passwordAgain" class="col-form-label"><b>确认密码</b></label>
                            <input type="password" class="form-control" id="password2" name="password2"
                                placeholder="再次输入密码">
                        </div>
                        <div class="form-group">
                            <label for="email" class="col-form-label"><b>邮箱</b></label>
                            <input type="email" class="form-control" id="email" name="email" placeholder="输入e-mail邮箱地址">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="submit" id="registsubmit" class="btn btn-primary" data-dismiss="modal">注册</button>
                    </div>
                </form>
                <iframe id="register_display" name="register_display" style="display: none;"></iframe>
            </div>
        </div>
    </div>

    <!-- 登录窗口 -->
    <div class="modal fade" id="login" tabindex="-1" role="dialog" aria-labelledby="loginTitle" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title" id="loginTitle"><b>用户登录</b></h4>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close" style="outline:none">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <form>
                    <div class="modal-body">
                        <div class="form-group">
                            <label for="usernamel" class="col-form-label"><b>用户名</b></label>
                            <input type="text" class="form-control" id="usernamel" name="username" placeholder="输入用户名">
                        </div>
                        <div class="form-group">
                            <label for="passwordl" class="col-form-label"><b>密码</b></label>
                            <input type="password" class="form-control" id="passwordl" name="password"
                                placeholder="输入密码">
                        </div>

                    </div>
                    <div class="modal-footer">
                        <button type="submit" id="loginsubmit" class="btn btn-primary" data-dismiss="modal">登录</button>
                    </div>
                    <div class="tip"></div>
                </form>
            </div>
        </div>
    </div>

    <!-- 职位管理页面内容 -->
    <div class="container" style="margin-top: 72px;">
        <div class="nav">
            <h5 class="mr-auto">职位管理</h5>
            <button class="btn btn-primary" id="addInfo">添加</button>
        </div>
        <table class="table table-bordered" style="margin-top: 10px;">
            <thead class="text-center">
                <tr>
                    <th scope="col">序号</th>
                    <th scope="col">公司logo</th>
                    <th scope="col">职位名称</th>
                    <th scope="col">公司名称</th>
                    <th scope="col">工作经验</th>
                    <th scope="col">职位类型</th>
                    <th scope="col">工作地点</th>
                    <th scope="col">职位薪资</th>
                    <th scope="col">操作</th>
                </tr>
            </thead>
            <tbody id="data" style="font-size: 14px;">
                <tr>
                    <td colspan="9">暂无数据</td>
                </tr>
            </tbody>
        </table>
        <!-- <nav aria-label="这是一个工作信息分页" class="float-right">
            <ul class="pagination">
              <li class="page-item">
                <a class="page-link" href="#" aria-label="Previous">
                  <span aria-hidden="true">&laquo;</span>
                  <span class="sr-only">Previous</span>
                </a>
              </li>
              <li class="page-item active"><a class="page-link" href="#">1</a></li>
              <li class="page-item"><a class="page-link" href="#">2</a></li>
              <li class="page-item"><a class="page-link" href="#">3</a></li>
              <li class="page-item">
                <a class="page-link" href="#" aria-label="Next">
                  <span aria-hidden="true">&raquo;</span>
                  <span class="sr-only">Next</span>
                </a>
              </li>
            </ul>
          </nav> -->
    </div>

    <!-- 添加职位管理数据 -->
    <div class="modal fade" id="add" tabindex="-1" role="dialog" aria-labelledby="addTitle" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title" id="addTitle"><b>职位信息</b></h4>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close" style="outline:none">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <form action="/addinfo" method="POST" id="jobinfo" enctype="multipart/form-data" target="register_display">
                    <div class="modal-body">
                        <div class="form-group">
                            <label for="gslogo" class="col-form-label"><b>公司logo</b></label>
                            <input type="file" class="form-control" id="gslogo" name="gslogo" >
                        </div>
                        <div class="form-group">
                            <label for="zwname" class="col-form-label"><b>职位名称</b></label>
                            <input type="text" class="form-control" id="zwname" name="zwname"
                                placeholder="输入职位名称" autocomplete="off">
                        </div>
                        <div class="form-group">
                            <label for="gsname" class="col-form-label"><b>公司名称</b></label>
                            <input type="text" class="form-control" id="gsname" name="gsname"
                                placeholder="输入公司名称" autocomplete="off">
                        </div>
                        <div class="form-group">
                            <label for="gzjy" class="col-form-label"><b>工作经验</b></label>
                            <input type="text" class="form-control" id="gzjy" name="gzjy" placeholder="输入工作经验" autocomplete="off">
                        </div>
                        <div class="form-group">
                            <label for="zwlx" class="col-form-label"><b>职位类型</b></label>
                            <input type="text" class="form-control" id="zwlx" name="zwlx" placeholder="输入职位类型" autocomplete="off">
                        </div>
                        <div class="form-group">
                            <label for="gzdd" class="col-form-label"><b>工作地点</b></label>
                            <input type="text" class="form-control" id="gzdd" name="gzdd"
                                placeholder="输入工作地点" autocomplete="off">
                        </div>
                        <div class="form-group">
                            <label for="gwxz" class="col-form-label"><b>岗位薪资</b></label>
                            <input type="text" class="form-control" id="gwxz" name="gwxz"
                                placeholder="输入岗位薪资" autocomplete="off">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="submit" id="submitinfo" class="btn btn-primary" data-dismiss="modal">提交</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="./javascripts/jquery-3.5.1.js"></script>
    <script src="./javascripts/bootstrap.min.js"></script>
    <script>
        $(function (){
            // 给导航栏添加点击事件委托，点击切换高亮显示
            $('.nav-item').on('click', '.nav-link', function (e){
                $('.nav-item .nav-link').removeClass('active');
                $(e.target).addClass('active');
            })

            // 验证密码是否输入一致
            $('#password2').on('blur', function () {
                if (passwordr.value != password2.value && password2.value != "") {
                    $('#password2').next().remove();
                    $('#password2').after(
                        '<div class="alert alert-danger" role="alert" style="margin-top: 10px;">密码输入不一致，请重新输入</div>'
                    )
                } else {
                    $('#password2').next().remove();
                }
            })
            // 给注册按钮添加表单提交事件
            $('#registsubmit').on('click', function () {
                if (passwordr.value != password2.value) {
                    return;
                }
                $('#registered').submit();
            })

            // 给登录按钮添加ajax请求
            $('#loginsubmit').on('click', function () {
                $.ajax({
                    url: '/login',
                    method: 'post',
                    data: {
                        username: usernamel.value,
                        password: passwordl.value
                    },
                    success: function (result) {
                        if (result.meta.state == 200) {
                            sessionStorage.setItem('username', result.data);
                            location.reload();
                        } else {
                            alert(result.data);
                        }
                    },
                    error: function (err) {
                        console.log(err);
                    }
                })
            })
            
            // 当用户登录后
            if(sessionStorage.getItem('username')){
                // 载入页面是如果有用户名存储，那么页面保存用户登录状态
                $('#loginup').html('<span class="nav-link">你好，'+ sessionStorage.getItem('username')+'</span>');
                $('#loginout').html('<a href="javascript:void(0)" class="nav-link" id ="logout">注销</a>');

                // 添加按钮有了添加功能
                $('#addInfo').attr({
                    'data-toggle' : "modal",
                    'data-target' : "#add"
                })
 
                //提交按钮设置点击事件
                $('#submitinfo').on('click',function (){
                    // var formData = new FormData($('#jobinfo')[0]);
                    $('#jobinfo').find('.modal-body').append(`<input type="hidden" id="username" name="username" value="${sessionStorage.getItem('username')}" >`)
                    $('#jobinfo').submit();
                    location.reload();
                })

                $.ajax({
                    url: '/',
                    method: 'post',
                    data: {username: sessionStorage.getItem('username')},
                    success: function (result){
                        if(result.meta.state == 200){
                            if(result.data){
                                $('#data').html(function (){
                                    var str = ``;
                                    result.data.sort(function (a,b){return -1}).forEach((item, index) => {
                                        str += `<tr>
                                                    <td>${index+1}</td>
                                                    <td><img src=${item['imgurl']} alt="" width="55px" height="24px"></td>
                                                    <td>${item['zwname']}</td>
                                                    <td>${item['gsname']}</td>
                                                    <td>${item['gzjy']}</td>
                                                    <td>${item['zwlx']}</td>
                                                    <td>${item['gzdd']}</td>
                                                    <td>${item['gwxz']}</td>
                                                    <td>
                                                        <a href="/updata?id=${item['_id']}" data-toggle="modal" data-target="#add">修改</a>
                                                        <a href="/delete?id=${item['_id']}">删除</a>
                                                    </td>
                                                </tr>`
                                    })
                                    return str;
                                })
                                $('#data').addClass('text-center');
                            }
                        }else{
                            alert(result.meta.msg)
                        }
                    },
                    error: function (err){
                        console.log(err);
                    }
                })
            }else{
                $('#loginup').html('<a href="javascript:void(0)" class="nav-link" data-toggle="modal" data-target="#login">登录</a>');
                $('#loginout').html('<a href="javascript:void(0)" class="nav-link" data-toggle="modal" data-target="#register">注册</a>')
            }

            //当点击注销按钮是清除登录状态
            $('#logout').click(function (){
                sessionStorage.clear();
                location.reload();
            })
        })
    </script>
</body>

</html>